<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Listado pacientes ¬∑ Cl√≠nica Paula Gilabert</title>
<style>
:root{--bg:#f7eef2;--card:#fff5f7;--accent:#cfa3a9;--accent-2:#e9d7db;--muted:#8B6B6F;--text:#3b2b2d}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,var(--bg),#fbf5f6);color:var(--text);-webkit-font-smoothing:antialiased}
.container{width:98vw;max-width:1600px;margin:8px auto;padding:8px}
.app{background:linear-gradient(180deg,var(--card),#fff);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(203,164,169,0.08);border:1px solid rgba(207,163,169,0.08)}
.header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
.title{margin:0;font-size:18px}
.lead{margin:0;color:var(--muted);font-size:13px}
.layout{display:flex;gap:16px;min-height:70vh}
.left{flex:1 1 auto;min-width:0}
.right{flex:0 0 30%;min-width:260px;max-width:360px}
.controls{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--card),#fff);padding-bottom:6px;margin-bottom:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-bottom:1px dashed rgba(150,120,125,0.12)}
input[type=text],select,textarea{padding:8px;border-radius:10px;border:1px solid rgba(150,120,125,0.12);background:rgba(255,255,255,0.95);width:100%}
button{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
button.ghost{background:transparent;border:1px solid rgba(150,120,125,0.12);color:var(--text);padding:6px 10px}
/* table wrapper scrolls; header/controls stay */
.table-wrap{border-radius:10px;border:1px solid rgba(207,163,169,0.06);background:linear-gradient(#fff,#fffafc);overflow:auto}
.table-wrap::-webkit-scrollbar{height:10px;width:10px}
.table-wrap::-webkit-scrollbar-thumb{background:rgba(150,120,125,0.25);border-radius:8px}
/* table layout compact */
table{min-width:920px;width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:8px 6px;text-align:left;font-size:12px;border-bottom:1px dashed rgba(150,120,125,0.06);vertical-align:middle;word-break:break-word}
th{color:var(--muted);font-weight:700;background:#fff5f8;position:sticky;top:0;z-index:2}
/* row status colors */
tr.row-sent{background:rgba(120,200,120,0.12)}
tr.row-pending{background:rgba(255,210,80,0.14)}
tr.row-confirmed{background:rgba(120,120,120,0.05)}
.pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#fff;border:1px solid rgba(207,163,169,0.18);color:var(--accent);font-weight:700}
.card{background:linear-gradient(180deg,#fff,#fffafc);padding:12px;border-radius:10px;border:1px solid rgba(207,163,169,0.06)}
.small{font-size:12px;color:var(--muted)}
.note{font-size:12px;color:var(--muted);margin-top:8px}
/* right panel: border + defined shadow */
.right-panel{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(200,200,200,0.9);box-shadow:0 10px 26px rgba(0,0,0,0.18)}
/* banner centered */
.banner{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#fff;border:1px solid rgba(207,163,169,0.12);padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(203,164,169,0.12);display:none;z-index:999}
/* spinner */
.spinner{width:16px;height:16px;border-radius:50%;border:3px solid rgba(207,163,169,0.25);border-top-color:var(--accent);animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
/* edit button pink, larger */
button.edit{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;font-weight:700;font-size:14px}
button.edit:hover{transform:translateY(-1px)}
/* order selector container */
.order-bar{display:flex;justify-content:flex-end;align-items:center;gap:8px;margin:6px 0}
@media (max-width:980px){.layout{flex-direction:column}.right{order:2;max-width:100%;min-width:100%}.table-wrap{overflow-x:auto}}
</style>
</head>
<body>
<!-- Google APIs -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<div class="container">
  <div class="app">
    <div class="header">
      <div class="logo">CL</div>
      <div>
        <h1 class="title">Listado de pacientes ¬∑ Cl√≠nica Paula Gilabert</h1>
        <p class="lead">Protegido ¬∑ Drive sincronizado ¬∑ Import/Export CSV ¬∑ Env√≠o WhatsApp</p>
      </div>
    </div>

    <div class="layout">
      <div class="left">
        <div class="controls">
          <input id="search" type="text" placeholder="Buscar por nombre, tratamiento o nota" style="flex:1;min-width:180px" />
          <select id="filterMonth"><option value="">Todos los meses</option><option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option></select>
          <select id="filterCita"><option value="">Todas las citas</option><option>Confirmada</option><option>Pendiente</option></select>
          <label style="display:flex;align-items:center;gap:6px"><input id="selectAll" type="checkbox"> Seleccionar todo</label>
          <button id="sendSelected">Enviar WhatsApp</button>
          <button id="markContacted" class="ghost">Marcar como contactado</button>
          <button id="deleteSelected" class="ghost">Borrar</button>
          <button id="downloadCSV" class="ghost">Descargar CSV</button>
          <button id="importBtn" class="ghost">üìÇ Importar CSV</button>
          <button id="btnDrive" class="ghost">Conectar Drive</button>
          <div id="driveStatus" class="small">Sincronizaci√≥n: no conectada</div>
          <div id="syncSpinner" style="margin-left:8px;display:none"><span class="spinner"></span><span class="small">Sincronizando...</span></div>
        </div>

        <div class="order-bar">
          <span class="small">Ordenar por:</span>
          <select id="orderBy">
            <option value="fechaAsc">Fecha (antiguo ‚Üí reciente)</option>
            <option value="fechaDesc">Fecha (reciente ‚Üí antiguo)</option>
            <option value="nombreAsc">Nombre (A ‚Üí Z)</option>
            <option value="mesAsc">Mes (Enero ‚Üí Diciembre)</option>
          </select>
        </div>

        <div id="counter" class="small note">Mostrando 0 de 0 pacientes</div>

        <div id="tableWrap" class="table-wrap card" style="margin-top:6px;">
          <table id="patientsTable">
            <thead>
              <tr>
                <th style="width:36px"></th>
                <th style="width:200px">Nombre</th>
                <th style="width:110px">Tel√©fono</th>
                <th style="width:140px">Tratamiento</th>
                <th style="width:80px">Mes</th>
                <th style="width:90px">Cita</th>
                <th style="width:180px">Notas</th>
                <th style="width:80px">Enviado</th>
                <th style="width:100px">Acciones</th>
                <th style="width:150px">Fecha</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="right">
        <div class="right-panel">
          <div style="display:flex;flex-direction:column;gap:10px">
            <input id="name" type="text" placeholder="Nombre" />
            <input id="phone" type="text" placeholder="Tel√©fono (+346...)" />
            <input id="treatment" type="text" placeholder="Tratamiento" />
            <select id="month" style="width:100%"><option value="">Mes</option><option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option></select>
            <select id="cita" style="width:100%"><option>Confirmada</option><option>Pendiente</option></select>
            <textarea id="notes" rows="4" placeholder="Notas..."></textarea>
            <button id="save" style="width:100%">A√±adir paciente</button>
          </div>
          <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(150,120,125,0.06)" />
          <div class="small">Plantilla mensaje (puedes editar):</div>
          <textarea id="template" rows="4" style="width:100%;margin-top:8px">Hola {{nombre}}, ya tenemos los d√≠as disponibles del mes de {{mes}}, para poder gestionar tu cita dime si prefieres la cita por la ma√±ana o la tarde. Un saludo.</textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="bottomBanner" class="banner"></div>
<input id="fileInput" type="file" accept=".csv" style="display:none" />

<script>
// ---- Password ----
(function(){ const PASSWORD='clinica2025'; const p = prompt('Introduce la contrase√±a para acceder:'); if(p !== PASSWORD){ alert('Contrase√±a incorrecta'); document.body.innerHTML = '<h1 style="text-align:center;margin-top:120px;color:#c44">Acceso denegado</h1>'; throw new Error('Acceso denegado'); }})();

window.addEventListener('DOMContentLoaded', ()=>{
  // ---- Config (Drive estable) ----
  const CLIENT_ID = '521234179969-hrpf9mm4s5tmm2hl3afg5m9m9dmsqph3.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';
  const DRIVE_FILE_NAME = 'pacientes_clinica.json';
  const LS_KEY = 'clinica_pacientes_final_v9';

  // ---- State ----
  let patients = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  let editingIndex = null;
  let accessToken = null; let tokenClient = null; let fileId = null;
  const selectedIds = new Set(); // persist selection across filtros/orden

  // ---- Helpers ----
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function showBanner(msg, timeout=3500){ const b = document.getElementById('bottomBanner'); b.textContent = msg; b.style.display='block'; setTimeout(()=> b.style.display='none', timeout); }
  function showSpinner(show){ document.getElementById('syncSpinner').style.display = show ? 'inline-block' : 'none'; }
  function sanitizePhone(raw){ if(!raw) return ''; let d = raw.replace(/[^0-9+]/g,''); if(d.startsWith('00')) d = '+'+d.slice(2); let digits = d.replace(/\D/g,''); if(digits.length===9) digits = '34'+digits; return digits; }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  const MONTHS = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

  // ---- Altura din√°mica de la tabla ----
  function adjustTableHeight(){ const wrap = document.getElementById('tableWrap'); const rect = wrap.getBoundingClientRect(); const h = window.innerHeight - rect.top - 16; wrap.style.maxHeight = h + 'px'; wrap.style.height = h + 'px'; }
  window.addEventListener('resize', adjustTableHeight);

  // ---- Orden ----
  function sortPatients(arr){ const mode = $('#orderBy').value; const getMonthIndex = m => MONTHS.indexOf(m);
    const copy = arr.slice();
    if(mode==='fechaAsc') copy.sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
    else if(mode==='fechaDesc') copy.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    else if(mode==='nombreAsc') copy.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    else if(mode==='mesAsc') copy.sort((a,b)=> getMonthIndex(a.month||'') - getMonthIndex(b.month||''));
    return copy;
  }
  function rowClass(p){ if(p.sent) return 'row-sent'; if((p.cita||'').toLowerCase()==='pendiente') return 'row-pending'; return 'row-confirmed'; }

  // ---- Render ----
  function renderTable(){ const tbody = $('#patientsTable tbody'); tbody.innerHTML='';
    const q = $('#search').value.trim().toLowerCase(); const mf = $('#filterMonth').value; const cf = $('#filterCita').value;
    let filtered = patients.filter(p=>{
      const okQ = !q || (p.name||'').toLowerCase().includes(q) || (p.treatment||'').toLowerCase().includes(q) || (p.notes||'').toLowerCase().includes(q);
      const okM = !mf || p.month===mf; const okC = !cf || p.cita===cf; return okQ && okM && okC; });
    const ordered = sortPatients(filtered);
    let shown=0;
    ordered.forEach(p=>{
      if(!p.createdAt) p.createdAt = new Date().toISOString();
      shown++;
      const tr = document.createElement('tr'); tr.className = rowClass(p);
      const checked = selectedIds.has(p.createdAt) ? 'checked' : '';
      tr.innerHTML = `
        <td style="text-align:center"><input class=\"sel\" type=\"checkbox\" data-id=\"${p.createdAt}\" ${checked}></td>
        <td style=\"overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${escapeHtml(p.name)}</td>
        <td style=\"overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${escapeHtml(p.phone)}</td>
        <td style=\"overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${escapeHtml(p.treatment)}</td>
        <td>${escapeHtml(p.month)}</td>
        <td>${escapeHtml(p.cita)}</td>
        <td style=\"overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${escapeHtml(p.notes||'')}</td>
        <td style=\"text-align:center\">${p.sent?'<span class=\"pill\">Enviado</span>':''}</td>
        <td style=\"text-align:center\"><button class=\"edit\" data-id=\"${p.createdAt}\">‚úèÔ∏è Editar</button></td>
        <td style=\"overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${new Date(p.createdAt).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
    $('#counter').textContent = `Mostrando ${shown} de ${patients.length} pacientes`;
    adjustTableHeight();
  }

  // ---- Delegaci√≥n eventos: editar + selecci√≥n ----
  const tableEl = document.getElementById('patientsTable');
  tableEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button.edit');
    if(btn){ const id = btn.dataset.id; const i = patients.findIndex(pp=>pp.createdAt===id); if(i>=0) startEdit(i); return; }
  });
  tableEl.addEventListener('change', (e)=>{
    const cb = e.target.closest('input.sel');
    if(cb){ const id = cb.dataset.id; if(cb.checked) selectedIds.add(id); else selectedIds.delete(id); }
  });
  function getSelectedIndexes(){ return Array.from(selectedIds).map(id=> patients.findIndex(p=>p.createdAt===id)).filter(i=> i>=0); }

  // ---- Persistencia local + Drive (estable) ----
  function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(patients)); renderTable(); if(accessToken && fileId){ showSpinner(true); syncToDrive().then(()=> showSpinner(false)); } }

  // ---- CRUD ----
  function startEdit(i){ editingIndex = i; const p = patients[i]; $('#name').value = p.name||''; $('#phone').value = p.phone||''; $('#treatment').value = p.treatment||''; $('#month').value = p.month||''; $('#cita').value = p.cita||'Confirmada'; $('#notes').value = p.notes||''; }
  $('#save').addEventListener('click', ()=>{ const name = $('#name').value.trim(); const phoneRaw = $('#phone').value.trim(); if(!name || !phoneRaw) return alert('Nombre y tel√©fono obligatorios'); const base = { name, phone: sanitizePhone(phoneRaw), treatment: $('#treatment').value.trim(), month: $('#month').value, cita: $('#cita').value, notes: $('#notes').value.trim(), sent: false };
    if(editingIndex!==null){ base.createdAt = patients[editingIndex].createdAt; patients[editingIndex] = base; editingIndex = null; } else { base.createdAt = new Date().toISOString(); patients.push(base); }
    selectedIds.add(base.createdAt);
    $('#name').value=''; $('#phone').value=''; $('#treatment').value=''; $('#month').value=''; $('#cita').value='Confirmada'; $('#notes').value='';
    saveLocal(); showBanner('‚úÖ Paciente guardado');
  });

  // ---- Controles superiores ----
  $('#selectAll').addEventListener('change', e=>{ const q = $('#search').value.trim().toLowerCase(); const mf = $('#filterMonth').value; const cf = $('#filterCita').value; const filtered = sortPatients(patients.filter(p=>{ const okQ = !q || (p.name||'').toLowerCase().includes(q) || (p.treatment||'').toLowerCase().includes(q) || (p.notes||'').toLowerCase().includes(q); const okM = !mf || p.month===mf; const okC = !cf || p.cita===cf; return okQ && okM && okC; }));
    if(e.target.checked) filtered.forEach(p=> selectedIds.add(p.createdAt)); else filtered.forEach(p=> selectedIds.delete(p.createdAt)); renderTable(); });
  $('#orderBy').addEventListener('change', renderTable);
  $('#search').addEventListener('input', renderTable);
  $('#filterMonth').addEventListener('change', renderTable);
  $('#filterCita').addEventListener('change', renderTable);

  // ---- WhatsApp multiple ----
  $('#sendSelected').addEventListener('click', ()=>{ const idxs = getSelectedIndexes(); if(idxs.length===0) return showBanner('‚ö†Ô∏è No hay pacientes seleccionados'); if(!confirm(`Se abrir√°n ${idxs.length} pesta√±as para enviar WhatsApp. Continuar?`)) return; let blocked=false; idxs.forEach(i=>{ const p = patients[i]; const tpl = $('#template').value; const msg = tpl.replace(/{{\s*nombre\s*}}/gi,p.name).replace(/{{\s*mes\s*}}/gi,p.month).replace(/{{\s*tratamiento\s*}}/gi,p.treatment); const tel = (p.phone||'').replace(/\D/g,''); const win = window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`,'_blank'); if(!win) blocked=true; else p.sent = true; }); if(blocked) showBanner('‚ö†Ô∏è Algunas ventanas fueron bloqueadas. Permite pop-ups.'); saveLocal(); });

  // ---- Marcar / Borrar -----
  $('#markContacted').addEventListener('click', ()=>{ const idxs = getSelectedIndexes(); if(idxs.length===0) return showBanner('‚ö†Ô∏è No hay seleccionados'); idxs.forEach(i=> patients[i].sent = true); saveLocal(); showBanner('‚úÖ Seleccionados marcados como contactados'); });
  $('#deleteSelected').addEventListener('click', ()=>{ const ids = Array.from(selectedIds); if(ids.length===0) return showBanner('‚ö†Ô∏è No hay seleccionados'); if(!confirm('Borrar pacientes seleccionados?')) return; patients = patients.filter(p=> !selectedIds.has(p.createdAt)); selectedIds.clear(); saveLocal(); showBanner('‚úÖ Pacientes eliminados'); });

  // ---- CSV export (igual que estable) ----
  $('#downloadCSV').addEventListener('click', ()=>{ try{ let csv = 'Nombre,Telefono,Tratamiento,Mes,Cita,Notas,Enviado,Fecha\n'; patients.forEach(p=>{ csv += `"${(p.name||'').replace(/"/g,'""')}","${p.phone||''}","${(p.treatment||'').replace(/"/g,'""')}","${p.month||''}","${p.cita||''}","${(p.notes||'').replace(/"/g,'""')}","${!!p.sent}","${p.createdAt}"\n`; }); const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_pacientes.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); showBanner('‚úÖ Backup CSV descargado'); }catch(err){ console.error('download err',err); showBanner('Error al descargar backup'); } });

  // ---- CSV import (A√ëADIR a existentes, tolerante) ----
  $('#importBtn').addEventListener('click', ()=> $('#fileInput').click());
  $('#fileInput').addEventListener('change', async function(e){ const file = e.target.files[0]; if(!file) return; try{
      const arr = await file.arrayBuffer();
      let text='';
      try{ text = new TextDecoder('utf-8',{fatal:true}).decode(arr); }
      catch(err){ text = new TextDecoder('windows-1252').decode(arr); }
      const clean = text.replace(/\r/g,'');
      const lines = clean.split('\n').filter(l=>l.trim()!=='');
      if(lines.length < 2) return alert('CSV vac√≠o o con formato no v√°lido');
      let sep = ','; const first = lines[0];
      if(first.includes('\t')) sep='\t'; else if(first.includes(';') && (!first.includes(',') || first.split(';').length>first.split(',').length)) sep=';';
      const norm = s => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
      const headersRaw = first.split(sep).map(h=>h.trim());
      const headers = headersRaw.map(h=> norm(h.replace(/√É¬©/g,'e')));
      const getVal = (rowObj, keys) => { for(const k of keys){ if(rowObj[k]!==undefined) return rowObj[k]; } return ''; };
      const imported = [];
      for(let i=1;i<lines.length;i++){
        const vals = lines[i].split(sep).map(v=> v.trim().replace(/^"|"$/g,''));
        if(vals.length < 2) continue;
        const row = {}; headers.forEach((hh,idx)=> row[hh] = vals[idx] || '');
        const name = getVal(row,['nombre','name']);
        const phoneRaw = getVal(row,['telefono','telefono','tel√©fono','tel√É¬©fono','phone']);
        const treatment = getVal(row,['tratamiento','treatment']);
        const month = getVal(row,['mes','month']);
        const cita = getVal(row,['cita']);
        const notes = getVal(row,['notas','notes']);
        const sentStr = String(getVal(row,['enviado','sent'])).toLowerCase();
        const fechaRaw = getVal(row,['fecha','createdat','fecha de creacion']);
        let createdAt = new Date().toISOString();
        if(fechaRaw){ const parsed = Date.parse(fechaRaw); if(!isNaN(parsed)) createdAt = new Date(parsed).toISOString(); }
        imported.push({ name, phone: sanitizePhone(phoneRaw), treatment, month, cita: cita||'Confirmada', notes, sent: (sentStr==='true'), createdAt });
      }
      // A√ëADIR (permitir duplicados)
      patients = patients.concat(imported);
      saveLocal();
      showBanner(`‚úÖ Se a√±adieron ${imported.length} pacientes del CSV (duplicados permitidos)`);
    }catch(err){ console.error('import err',err); showBanner('Error leyendo el CSV'); } finally{ e.target.value = ''; } });

  // ---- Google Drive (mismo flujo estable) ----
  function gapiInit(){ gapi.load('client', async ()=>{ await gapi.client.init({ discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] }); console.log('gapi ready'); }); }
  gapiInit();

  $('#btnDrive').addEventListener('click', ()=>{
    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: async (resp)=>{ if(resp.error){ console.error(resp); showBanner('Error autenticando en Google'); return; } accessToken = resp.access_token; $('#driveStatus').textContent = '‚úÖ Conectado a Google Drive'; await loadOrCreateFile(); await syncToDrive(); } }); tokenClient.requestAccessToken(); });

  async function loadOrCreateFile(){ try{ const res = await gapi.client.drive.files.list({ q: `name='${DRIVE_FILE_NAME}' and trashed=false`, fields: 'files(id,name)' }); if(res.result.files && res.result.files.length>0){ fileId = res.result.files[0].id; await loadFileFromDrive(); } else { await createFileOnDrive(); } }catch(err){ console.error('list error',err); showBanner('Error al buscar archivo en Drive'); } }

  async function createFileOnDrive(){ try{ const metadata = { name: DRIVE_FILE_NAME, mimeType: 'application/json' }; const body = JSON.stringify({ pacientes: patients }); const form = new FormData(); form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' })); form.append('file', new Blob([body], { type: 'application/json' })); const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: 'Bearer ' + accessToken }, body: form }); const data = await resp.json(); fileId = data.id; console.log('File created', fileId); showBanner('‚úÖ Archivo creado en Drive'); }catch(err){ console.error('create err',err); showBanner('Error creando archivo en Drive'); } }

  async function loadFileFromDrive(){ try{ const res = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' }); const raw = res.body || JSON.stringify(res.result) || '{}'; const data = typeof raw === 'string' ? JSON.parse(raw) : raw; if(Array.isArray(data.pacientes)){ patients = data.pacientes; selectedIds.clear(); saveLocal(); showBanner('‚úÖ Datos cargados desde Drive'); } console.log('Loaded from Drive'); }catch(err){ console.error('load err',err); showBanner('Error cargando datos desde Drive'); } }

  async function syncToDrive(){ if(!fileId || !accessToken) return; try{ const content = JSON.stringify({ pacientes: patients }); const resp = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, { method:'PATCH', headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' }, body: content }); if(!resp.ok) { console.error('sync failed', await resp.text()); showBanner('Error sincronizando con Drive'); } else { console.log('Synced'); showBanner('‚úÖ Sincronizado con Drive'); } }catch(err){ console.error('sync err',err); showBanner('Error sincronizando con Drive'); } }

  // Sync on unload
  window.addEventListener('beforeunload', ()=>{ if(accessToken && fileId) syncToDrive(); });

  // Inicial
  renderTable();
});
</script>
</body>
</html>
