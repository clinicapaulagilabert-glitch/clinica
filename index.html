<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Listado pacientes · WhatsApp (selección múltiple)</title>
<style>
:root{--bg:#f7eef2;--card:#fff5f7;--accent:#cfa3a9;--accent-2:#e9d7db;--muted:#8b6b6f;--text:#3b2b2d}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:linear-gradient(180deg,var(--bg),#fbf5f6);color:var(--text);font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;padding:28px}
.app{max-width:1100px;margin:0 auto;background:linear-gradient(180deg,var(--card),#fff);border-radius:16px;padding:22px;box-shadow:0 8px 30px rgba(203,164,169,0.12);border:1px solid rgba(207,163,169,0.12)}
header{display:flex;gap:14px;align-items:center;margin-bottom:14px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
h1{font-size:20px;margin:0}
.lead{margin:0;color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
input[type=text],select,textarea{padding:8px;border-radius:10px;border:1px solid rgba(150,120,125,0.12);background:rgba(255,255,255,0.6)}
button{background:var(--accent);border:none;color:white;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
button.ghost{background:transparent;border:1px solid rgba(150,120,125,0.08);color:var(--text)}
.table{background:transparent;border-radius:12px;padding:10px;overflow:auto;max-height:520px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 8px;text-align:left;font-size:14px;border-bottom:1px dashed rgba(150,120,125,0.06)}
th{color:var(--muted);font-weight:600}
.pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#fff;border:1px solid rgba(207,163,169,0.18);color:var(--accent);font-weight:700}
.card{background:linear-gradient(180deg,#fff,#fffafc);padding:14px;border-radius:12px;border:1px solid rgba(207,163,169,0.06)}
.small{font-size:12px;color:var(--muted)}
.actions td{white-space:nowrap}
@media (max-width:980px){.grid{grid-template-columns:1fr}.logo{display:none}}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">CL</div>
    <div>
      <h1>Listado de pacientes · Clínica estética</h1>
      <p class="lead">Selecciona varios pacientes y usa "Enviar WhatsApp a seleccionados". (Opción 1: abre una pestaña por paciente)</p>
    </div>
  </header>

  <div class="grid">
    <div>
      <div class="controls">
        <input id="search" type="text" placeholder="Buscar por nombre, tratamiento o nota" style="flex:1" />
        <select id="filterMonth"><option value="">Todos los meses</option>
          <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option>
          <option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
        </select>
        <select id="filterCita"><option value="">Todas las citas</option><option>Confirmada</option><option>Pendiente</option></select>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label><input id="selectAll" type="checkbox"> Seleccionar todo</label>
        <button id="sendSelected" class="btn-send">Enviar WhatsApp a seleccionados</button>
        <button id="markContacted" class="ghost">Marcar como contactado</button>
        <button id="deleteSelected" class="ghost">Borrar seleccionados</button>
      </div>

      <div class="table card">
        <table id="patientsTable">
          <thead>
            <tr>
              <th></th>
              <th>Nombre</th>
              <th>Teléfono</th>
              <th>Tratamiento</th>
              <th>Mes</th>
              <th>Cita</th>
              <th>Notas</th>
              <th>Enviado</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <aside>
      <div class="card">
        <h3 style="margin-top:0">Añadir / editar paciente</h3>
        <div class="field"><label>Nombre</label><input id="name" type="text" placeholder="Ej. Ana García" /></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1"><label>Teléfono</label><input id="phone" type="text" placeholder="Ej. +34655111222" /></div>
          <div style="width:120px"><label>Mes</label><select id="month"><option value="">-</option><option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option></select></div>
        </div>
        <div style="margin-top:8px"><label>Tratamiento</label><input id="treatment" type="text" placeholder="Ej. Mesoterapia" /></div>
        <div style="margin-top:8px"><label>Cita</label><select id="cita"><option>Confirmada</option><option>Pendiente</option></select></div>
        <div style="margin-top:8px"><label>Notas</label><textarea id="notes" rows="3" style="width:100%;border-radius:8px;padding:6px" placeholder="Notas..."></textarea></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="save">Guardar</button>
          <button id="reset" class="ghost">Nuevo</button>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(150,120,125,0.06)" />
        <h4>Plantilla de mensaje</h4>
        <p class="small">Usa <code>{{nombre}}</code>, <code>{{tratamiento}}</code>, <code>{{mes}}</code></p>
        <textarea id="template" rows="5" style="width:100%;border-radius:8px;padding:8px">Hola {{nombre}}, te recordamos tu tratamiento de {{tratamiento}} para el mes de {{mes}}. ¿Puedes confirmar tu asistencia?</textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="preview" class="ghost">Vista previa</button>
          <button id="sendAll" class="btn-send">Enviar a todos</button>
        </div>
        <p class="note small">Cuando se envía, la app intentará abrir una pestaña por paciente (permite pop-ups). Si tu navegador bloquea ventanas emergentes verás un aviso.</p>
      </div>
    </aside>
  </div>
</div>

<script>
const LS_KEY='clinica_pacientes_v_select';
let patients=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
let editingId=null;
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const fields={name:$('#name'),phone:$('#phone'),treatment:$('#treatment'),month:$('#month'),cita:$('#cita'),notes:$('#notes'),template:$('#template'),search:$('#search'),filterMonth:$('#filterMonth'),filterCita:$('#filterCita')};

function saveToStorage(){localStorage.setItem(LS_KEY,JSON.stringify(patients));}
function sanitizePhone(raw){if(!raw) return ''; let digits=raw.replace(/[^+0-9]/g,''); digits=digits.replace(/^00/,'+'); let plain=digits.replace(/[^0-9]/g,''); if(plain.length===9) plain='34'+plain; if(plain.length>9 && plain.startsWith('0')) plain=plain.replace(/^0+/,''); return plain;}
function buildMessage(template,p){return template.replace(/{{\s*nombre\s*}}/gi,p.nombre||'').replace(/{{\s*tratamiento\s*}}/gi,p.tratamiento||'').replace(/{{\s*mes\s*}}/gi,p.mes||'');}

function renderTable(){
  const tbody=$('#patientsTable tbody'); tbody.innerHTML='';
  const q=fields.search.value.trim().toLowerCase(); const monthF=fields.filterMonth.value; const citaF=fields.filterCita.value;
  patients.forEach(p=>{
    if(q && !(p.nombre||'').toLowerCase().includes(q) && !(p.tratamiento||'').toLowerCase().includes(q) && !((p.notes||'').toLowerCase().includes(q))) return;
    if(monthF && p.mes !== monthF) return; if(citaF && p.cita !== citaF) return;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input class="sel" type="checkbox" data-id="${p.id}"></td>
      <td>${escapeHtml(p.nombre||'')}</td>
      <td>${escapeHtml(p.telefono||'')}</td>
      <td>${escapeHtml(p.tratamiento||'')}</td>
      <td>${escapeHtml(p.mes||'')}</td>
      <td>${escapeHtml(p.cita||'')}</td>
      <td>${escapeHtml(p.notes||'')}</td>
      <td>${p.sent?'<span class="pill">Enviado</span>':'Pendiente'}</td>
      <td class="actions"><button class="btn-inline" data-edit="${p.id}">Editar</button> <button class="btn-inline" data-delete="${p.id}">Borrar</button> <button class="btn-inline" data-send="${p.id}">Enviar</button></td>
    `;
    tbody.appendChild(tr);
  });
  // attach events
  $$('.btn-inline[data-edit]').forEach(b=>b.onclick=e=>{ startEdit(e.currentTarget.dataset.edit); });
  $$('.btn-inline[data-delete]').forEach(b=>b.onclick=e=>{ if(confirm('Borrar paciente?')){ patients=patients.filter(x=>x.id!==e.currentTarget.dataset.delete); saveToStorage(); renderTable(); } });
  $$('.btn-inline[data-send]').forEach(b=>b.onclick=e=>{ sendSingle(e.currentTarget.dataset.send); });
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

function startEdit(id){const p=patients.find(x=>x.id===id); if(!p) return; editingId=id; fields.name.value=p.nombre; fields.phone.value=p.telefono; fields.treatment.value=p.tratamiento; fields.month.value=p.mes||''; fields.cita.value=p.cita||'Confirmada'; fields.notes.value=p.notes||'';}

$('#save').onclick=()=>{
  const name=fields.name.value.trim(); const phoneRaw=fields.phone.value.trim(); if(!name||!phoneRaw){alert('Nombre y teléfono obligatorios'); return;}
  const newP={id:editingId||Date.now().toString(36), nombre:name, telefono:sanitizePhone(phoneRaw), tratamiento:fields.treatment.value, mes:fields.month.value, cita:fields.cita.value, notes:fields.notes.value, sent:false };
  if(editingId){ patients = patients.map(p=>p.id===editingId? newP : p); } else { patients.unshift(newP); }
  editingId=null; saveToStorage(); renderTable(); $('#reset').click();
}

$('#reset').onclick=()=>{ editingId=null; fields.name.value=''; fields.phone.value=''; fields.treatment.value=''; fields.month.value=''; fields.cita.value='Confirmada'; fields.notes.value=''; }

$('#search').addEventListener('input',renderTable); $('#filterMonth').addEventListener('change',renderTable); $('#filterCita').addEventListener('change',renderTable);

$('#selectAll').addEventListener('change',e=>{ $$('.sel').forEach(ch=>ch.checked=e.target.checked); });

function getSelectedIds(){ return $$('.sel').filter(ch=>ch.checked).map(ch=>ch.dataset.id); }

function sendSingle(id){ const p = patients.find(x=>x.id===id); if(!p) return; const msg = buildMessage(fields.template.value,p); const tel = p.telefono; const win = window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`,'_blank'); if(!win) alert('Permite ventanas emergentes en tu navegador para enviar mensajes'); p.sent = true; saveToStorage(); renderTable(); }

$('#sendSelected').addEventListener('click',()=>{
  const ids = getSelectedIds(); if(ids.length===0){ alert('No hay pacientes seleccionados'); return; }
  if(!confirm(`Se abrirán ${ids.length} pestañas/ventanas para enviar WhatsApp. ¿Continuar?`)) return;
  let blocked=false;
  ids.forEach(id=>{
    const p = patients.find(x=>x.id===id); if(!p) return;
    const msg = buildMessage(fields.template.value,p);
    const win = window.open(`https://wa.me/${p.telefono}?text=${encodeURIComponent(msg)}`,'_blank');
    if(!win) blocked=true; else p.sent=true;
  });
  if(blocked) alert('Algunas ventanas fueron bloqueadas por el navegador. Permite pop-ups y vuelve a intentarlo.');
  saveToStorage(); renderTable();
});

$('#markContacted').addEventListener('click',()=>{ const ids=getSelectedIds(); if(ids.length===0){alert('No hay seleccionados');return;} patients.forEach(p=>{ if(ids.includes(p.id)) p.sent=true; }); saveToStorage(); renderTable(); });

$('#deleteSelected').addEventListener('click',()=>{ const ids=getSelectedIds(); if(ids.length===0){alert('No hay seleccionados');return;} if(!confirm('Borrar pacientes seleccionados?')) return; patients = patients.filter(p=>!ids.includes(p.id)); saveToStorage(); renderTable(); });

$('#sendAll').addEventListener('click',()=>{ if(patients.length===0){alert('No hay pacientes');return;} if(!confirm(`Se abrirán ${patients.length} pestañas para enviar a todos. Continuar?`)) return; let blocked=false; patients.forEach(p=>{ if(!p.sent){ const win=window.open(`https://wa.me/${p.telefono}?text=${encodeURIComponent(buildMessage(fields.template.value,p))}`,'_blank'); if(!win) blocked=true; else p.sent=true; }}); if(blocked) alert('Algunas ventanas fueron bloqueadas. Permite pop-ups.'); saveToStorage(); renderTable(); });

// helper: populate sample data if empty (optional for first use)
if(!patients || patients.length===0){ patients=[{id:Date.now().toString(36),nombre:'Ana García',telefono:'34655111222',tratamiento:'Mesoterapia',mes:'Octubre',cita:'Confirmada',notes:'Alergia a X',sent:false}]; saveToStorage(); }

renderTable();
</script>
</body>
</html>
Rename index file
