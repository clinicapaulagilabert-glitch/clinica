<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Listado pacientes ¬∑ Cl√≠nica Paula Gilabert</title>
<style>
:root{--bg:#f7eef2;--card:#fff5f7;--accent:#cfa3a9;--accent-2:#e9d7db;--muted:#8b6b6f;--text:#3b2b2d}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,var(--bg),#fbf5f6);color:var(--text);-webkit-font-smoothing:antialiased;padding:18px}
.app{max-width:1100px;margin:0 auto;background:linear-gradient(180deg,var(--card),#fff);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(203,164,169,0.12);border:1px solid rgba(207,163,169,0.12)}
header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
h1{font-size:18px;margin:0}
.lead{margin:0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
input[type=text],select,textarea{padding:8px;border-radius:10px;border:1px solid rgba(150,120,125,0.12);background:rgba(255,255,255,0.7)}
button{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
button.ghost{background:transparent;border:1px solid rgba(150,120,125,0.08);color:var(--text)}
.table{background:transparent;border-radius:12px;padding:10px;overflow:auto;max-height:520px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 6px;text-align:left;font-size:13px;border-bottom:1px dashed rgba(150,120,125,0.06)}
th{color:var(--muted);font-weight:600}
.pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#fff;border:1px solid rgba(207,163,169,0.18);color:var(--accent);font-weight:700}
.card{background:linear-gradient(180deg,#fff,#fffafc);padding:12px;border-radius:10px;border:1px solid rgba(207,163,169,0.06)}
.small{font-size:12px;color:var(--muted)}
.note{font-size:12px;color:var(--muted);margin-top:8px}
@media (max-width:980px){.grid{grid-template-columns:1fr}.logo{display:none}}
#driveStatus{font-size:13px;color:var(--muted);margin-bottom:8px}
</style>
</head>
<body>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ---------- CONFIG ----------
const CLIENT_ID='521234179969-hrpf9mm4s5tmm2hl3afg5m9m9dmsqph3.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/drive.file';
const DRIVE_FILE_NAME='pacientes_clinica.json';
const LS_KEY='clinica_pacientes_sync';
const PASSWORD='clinica2025';

let fileId=null;
let accessToken=null;
let tokenClient;

// ---------- PASSWORD ----------
if(prompt('Introduce la contrase√±a:')!==PASSWORD){alert('Contrase√±a incorrecta');document.body.innerHTML='<h1 style="text-align:center;margin-top:120px;color:#c44">Acceso denegado</h1>';throw new Error('Acceso denegado');}

// ---------- UI ----------
const appDiv=document.createElement('div');appDiv.className='app';document.body.appendChild(appDiv);

appDiv.innerHTML=`
  <div id="driveStatus">Sincronizaci√≥n: no conectada</div>
  <button id="btnDrive">Conectar con Google Drive</button>
  <input type="file" id="importCSV" accept=".csv" style="display:none" />
  <button onclick="document.getElementById('importCSV').click()">üìÇ Importar backup CSV</button>
  <input type="text" id="search" placeholder="Buscar paciente..." />
  <table id="patientsTable"><thead><tr><th><input type="checkbox" id="selectAll"></th><th>Nombre</th><th>Tel√©fono</th><th>Tratamiento</th><th>Mes</th><th>Cita</th><th>Notas</th><th>Enviado</th><th>Fecha Alta</th><th>Editar</th></tr></thead><tbody></tbody></table>
  <div id="counter" class="small"></div>
  <textarea id="template" style="width:100%;margin-top:8px;">Hola {{NOMBRE}}, ya tenemos los d√≠as disponibles del mes de {{MES}}, para poder gestionar tu cita dime si prefieres la cita por la ma√±ana o la tarde.\nUn saludo.</textarea>
  <button id="sendSelected">Enviar WhatsApp</button>
  <button id="markContacted">Marcar Contactado</button>
  <button id="deleteSelected">Borrar Seleccionados</button>
  <button id="downloadCSV">Descargar backup CSV</button>
`;

// ---------- FUNCIONES ----------
let patients=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
let editingIdx=null;

function renderTable(){
  const tbody=document.querySelector('#patientsTable tbody');tbody.innerHTML='';
  patients.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt)).forEach((p,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" class="sel" data-id="${idx}"></td><td>${p.name||''}</td><td>${p.phone||''}</td><td>${p.treatment||''}</td><td>${p.month||''}</td><td>${p.cita||''}</td><td>${p.notes||''}</td><td>${p.sent?'<span class="pill">Enviado</span>':''}</td><td>${new Date(p.createdAt).toLocaleString()}</td><td><button data-edit="${idx}">Editar</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('counter').textContent=`Mostrando ${patients.length} pacientes`;
}
renderTable();

function saveLocal(){ localStorage.setItem(LS_KEY,JSON.stringify(patients)); renderTable(); if(accessToken) syncLocalToDrive(); }

// ---------- IMPORTAR CSV ----------
document.getElementById('importCSV').onchange=function(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const csv=ev.target.result.split('\n').filter(l=>l.trim()!== '');
    const headers=csv[0].split(',');
    const imported=[];
    for(let i=1;i<csv.length;i++){const vals=csv[i].split(','); if(vals.length!==headers.length) continue; const obj={}; headers.forEach((h,idx)=>{obj[h]=vals[idx]}); imported.push(obj);
    }
    patients=imported; saveLocal(); alert('‚úÖ Backup importado y sincronizado');
  };
  reader.readAsText(file);
};

// ---------- WHATSAPP ----------
document.getElementById('sendSelected').onclick=function(){
  const selected=$$('#patientsTable tbody input.sel').filter(cb=>cb.checked).map(cb=>Number(cb.dataset.id));
  if(selected.length===0){alert('No hay seleccionados'); return;}
  selected.forEach(i=>{
    const p=patients[i];
    const msg=document.getElementById('template').value.replace(/{{NOMBRE}}/gi,p.name).replace(/{{MES}}/gi,p.month);
    const url='https://wa.me/'+p.phone.replace(/\D/g,'')+'?text='+encodeURIComponent(msg);
    window.open(url,'_blank');
    p.sent=true;
  });
  saveLocal();
};

// ---------- MARCAR, BORRAR, BACKUP CSV ----------
$$('#markContacted')[0].onclick=function(){patients.forEach(p=>p.sent=true); saveLocal();};
$$('#deleteSelected')[0].onclick=function(){patients=patients.filter((p,i)=>!document.querySelectorAll('#patientsTable tbody input.sel')[i].checked); saveLocal();};
$$('#downloadCSV')[0].onclick=function(){
  let csv='Nombre,Tel√©fono,Tratamiento,Mes,Cita,Notas,Enviado,Fecha\n';
  patients.forEach(p=>{csv+=`"${p.name}","${p.phone}","${p.treatment}","${p.month}","${p.cita}","${p.notes}","${p.sent}","${p.createdAt}\n"`});
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup_pacientes.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
