<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Listado pacientes V9.1 · Clínica Paula Gilabert</title>
<style>
:root{--bg:#f7eef2;--card:#fff5f7;--accent:#cfa3a9;--accent-2:#e9d7db;--muted:#8B6B6F;--text:#3b2b2d}
body{margin:0;font-family:sans-serif;background:var(--bg)}
.container{padding:10px}
.banner{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#fff;border:1px solid rgba(207,163,169,0.4);padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(203,164,169,0.15);display:none;z-index:999;font-size:13px;max-width:80%}
</style>
</head>
<body>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<h2>Listado pacientes V9.1 · Clínica Paula Gilabert</h2>
<p>Versión de depuración: Drive y CSV mostrarán errores en el banner.</p>

<input type="file" id="fileInput" accept=".csv" />
<button id="btnDrive">Conectar Drive</button>

<div id="bottomBanner" class="banner"></div>

<script>
function showBanner(msg,timeout=6000){
  const b=document.getElementById('bottomBanner');
  b.innerText=msg; b.style.display='block';
  setTimeout(()=>b.style.display='none',timeout);
}

// ---- CSV debug ----
document.getElementById('fileInput').addEventListener('change', async function(e){
  const file=e.target.files[0]; if(!file) return;
  try{
    const arr=await file.arrayBuffer();
    let text='';
    try{ text=new TextDecoder('utf-8',{fatal:true}).decode(arr);}catch(err){ text=new TextDecoder('windows-1252').decode(arr); }
    const clean=text.replace(/\r/g,'');
    const lines=clean.split('\n').filter(l=>l.trim()!=='');
    if(lines.length<2){ showBanner('⚠️ CSV vacío'); return; }
    let sep=','; const first=lines[0];
    if(first.includes('\t')) sep='\t'; else if(first.includes(';') && (!first.includes(',')||first.split(';').length>first.split(',').length)) sep=';';
    const headers=first.split(sep).map(h=>h.trim());
    showBanner('CSV detectado: separador "'+sep+'" columnas: '+headers.join(', ')+' total filas: '+(lines.length-1));
  }catch(err){ console.error('CSV error',err); showBanner('Error leyendo CSV: '+err.message); }
});

// ---- Drive debug ----
const CLIENT_ID='521234179969-hrpf9mm4s5tmm2hl3afg5m9m9dmsqph3.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/drive.file';
let accessToken=null, tokenClient=null;

function gapiInit(){ gapi.load('client', async ()=>{
  await gapi.client.init({ discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
  console.log('gapi listo');
});}
gapiInit();

document.getElementById('btnDrive').addEventListener('click', ()=>{
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:CLIENT_ID, scope:SCOPES, 
    callback: async (resp)=>{
      if(resp.error){ console.error('Drive auth error',resp); showBanner('Error autenticando: '+JSON.stringify(resp)); return; }
      accessToken=resp.access_token;
      showBanner('✅ Autenticado en Drive, token recibido');
      try{
        const res=await gapi.client.drive.files.list({ q:"name='pacientes_clinica.json' and trashed=false", fields:'files(id,name)' });
        showBanner('Respuesta list: '+JSON.stringify(res.result));
      }catch(err){ console.error('Drive list error',err); showBanner('Error al listar archivos: '+err.message); }
    }
  });
  tokenClient.requestAccessToken();
});
</script>
</body>
</html>